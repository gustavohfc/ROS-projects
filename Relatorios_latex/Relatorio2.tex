\documentclass{llncs}

\usepackage{forest}
\usepackage[utf8]{inputenc}
\usepackage{listings}
\usepackage{hyperref}
\usepackage{algpseudocode}

\graphicspath{{./img_t2/}}


\definecolor{folderbg}{RGB}{124,166,198}
\definecolor{folderborder}{RGB}{110,144,169}
\def\Size{4pt}
\tikzset{
      folder/.pic={
        \filldraw[draw=folderborder,top color=folderbg!50,bottom color=folderbg]
          (-1.05*\Size,0.2\Size+5pt) rectangle ++(.75*\Size,-0.2\Size-5pt);  
        \filldraw[draw=folderborder,top color=folderbg!50,bottom color=folderbg]
          (-1.15*\Size,-\Size) rectangle (1.15*\Size,\Size);
      }
    }





\begin{document}

\title{Relatório do Trabalho 2}
\author{Gustavo Henrique Fernandes Carvalho - 14/0021671}
\institute{Fundamentos Computacionais de Robótica - 2017/2 - Universidade de Brasília}
\maketitle


O video da simulação está em \url{https://youtu.be/T5etANWVPl0}


\section{Informações do pacote}
\subsection{Dependências}
Para executar a simulação do trabalho 2 não é necessário nenhuma dependência além das dependências originais do pacote fcr2017, definidas no arquivo \textit{package.xml}.


\subsection{Rodando a simulação}
Para rodar a simulação é necessário apenas executar o seguinte comando no terminal:
\begin{lstlisting}[language=bash]
	$ roslaunch fcr2017 trabalho2.launch
\end{lstlisting}
O arquivo \textit{trabalho2.launch} já inicia todos os nós necessários para a simulação, inclusive o nó de controle do trabalho 2.

A simulação é dividida em 3 etapas, na primeira etapa o Pioneer se move para uma posição inicial no mapa topológico definida pelo usuário, na segunda etapa o Pioneer percorre todo o mapa topológico preenchendo a grade de ocupação de cada região do mapa, e na última etapa o Pioneer vai para a posição final também  definida pelo usuário, as interfaces de entrada e saída da simulação são explicadas com mais detalhes nas seções \ref{sec:entrada} e \ref{sec:saida}.


\subsection{Arquivos}
A Figura \ref{file_tree} mostra os novos arquivos do pacote fcr2017 utilizados para a realização do trabalho 2, os arquivos originais do pacote não são mostrados.

\pagebreak
\begin{figure}[h!]
\begin{forest}
      for tree={
        font=\ttfamily,
        grow'=0,
        child anchor=west,
        parent anchor=south,
        anchor=west,
        calign=first,
        inner xsep=7pt,
        edge path={
          \noexpand\path [draw, \forestoption{edge}]
          (!u.south west) +(7.5pt,0) |- (.child anchor) pic {folder} \forestoption{edge label};
        },
        % style for your file node 
        file/.style={edge path={\noexpand\path [draw, \forestoption{edge}]
          (!u.south west) +(7.5pt,0) |- (.child anchor) \forestoption{edge label};},
          inner xsep=2pt,font=\scriptsize\ttfamily
                     },
        before typesetting nodes={
          if n=1
            {insert before={[,phantom]}}
            {}
        },
        fit=band,
        before computing xy={l=15pt},
      }  
	[fcr2017
		[launch
			[trabalho2.launch - Utilizado para iniciar a simulação, file]
			[trabalho2.rviz - Configuração do RViz, file]
			[..., file]
		]
		[map\_output - Diretório onde as imagens das grades de ocupação são salvas.
		]
		[src
			[140021671\_Trabalho2.cpp - Código fonte do trabalho 2, file]
			[common\_lib - Biblioteca implementada para facilitar o reuso e modificação do código
				[common.cpp - Implementação de funções gerais, file]
				[common.h - Definição de funções e estruturas gerais, file]
				[graph.cpp - Implementação das funções para manipulação de grafo, file]
				[graph.h - Definição das funções e estruturas para manipulação de grafo, file]
				[grid\_map.cpp - Implementação das funções que fazem a grade de ocupação, file]
				[grid\_map.h - Definição das funções e estruturas que fazem a grade de ocupação, file]
				[laser\_sensor.cpp - Implementação das funções que manipulam os dados do sensor laser, file]
				[laser\_sensor.h - Definição das funções e estruturas que manipulam os dados do sensor laser, file]
				[motion\_controller.cpp - Implementação das funções de controle de movimento, file]
				[motion\_controller.h - Definição das funções e estruturas de controle de movimento, file]
				[odometer.cpp - Implementação das funções manipulam os dados do odômetro, file]
				[odometer.h - Definição das funções e estruturas manipulam os dados do odômetro, file]
			]
		]
		[CIC\_graph.txt - Definição do mapa topológico do primeiro andar do prédio CIC/EST, file]
		[README.md - Mais informações sobre o pacote, file]
		[..., file]
	]
\end{forest}
\caption{Estrutura dos arquivos.}
\label{file_tree}
\end{figure}


\section{Entrada de dados} \label{sec:entrada}
Toda a entrada de dados pelo usuário é feita pelo terminal, a simulação requer apenas dois dados de entrada do usuário, o nó inicial e o final, utilizados na primeira e última etapa da simulação respectivamente.

A entrada desses dois nós é feita de maneira semelhante, uma mensagem indicando que o programa está esperando o usuário digitar um nó é mostrada no terminal e a mensagem continua aparecendo até o usuário digitar um nó válido do mapa topológico como mostrado nas Figuras \ref{fig:inicial} e \ref{fig:final}.

\begin{figure}[h]
	\centering
	\includegraphics[scale=0.75]{no_inicial}
	\caption{Entrada do nó inicial}
	\label{fig:inicial}
\end{figure}
\begin{figure}[h]
	\centering
	\includegraphics[scale=0.75]{no_final}
	\caption{Entrada do nó final}
	\label{fig:final}
\end{figure}


\section{Saída de dados} \label{sec:saida}
As informações da simulação são apresentadas por 4 interfaces diferentes, descritas individualmente a seguir.

\subsection{Gazebo}
O Gazebo mostra o estado da simulação graficamente e em tempo real da simulação.

\subsection{RViz}
O RViz mostra a leitura dos sensores do Pioneer e a grade de ocupação, ambos atualizados em tempo real, como mostra a Figura \ref{fig:rviz}.

\begin{figure}
	\centerline{\includegraphics[scale=0.27]{rviz}}
	\caption{Simulação no RViz}
	\label{fig:rviz}
\end{figure}


\subsection{Terminal}
Informações sobre o que o Pioneer está fazendo são atualizados constantemente no terminal informando a localização, para onde ele está indo e qual etapa da simulação ele está, a figura \ref{fig:terminal} mostra um exemplo dessas mensagens.

\begin{figure}
	\centerline{\includegraphics[scale=0.5]{terminal}}
	\caption{Mensagens de atualização pelo terminal}
	\label{fig:terminal}
\end{figure}


\pagebreak
\subsection{Arquivos das grades de ocupação} \label{grid_file}
Quando as grades de ocupação de todas as regiões do mapa topológico estão completas, elas são salvas como imagens na pasta \textit{map\_output/}. As imagens correspondente a cada um dos nós do grafo são mostrados nas Figuras \ref{fig:grade_no_A} a \ref{fig:grade_no_R}.

\begin{figure}
	\centering
	\fbox{\includegraphics[scale=0.25]{cic_node_A}}
	\caption{Grade de ocupação do nó A}
	\label{fig:grade_no_A}
\end{figure}
\begin{figure}
	\centering
	\fbox{\includegraphics[angle=90,scale=0.25]{cic_node_B}}
	\caption{Grade de ocupação do nó B}
	\label{fig:grade_no_B}
\end{figure}
\begin{figure}
	\centering
	\fbox{\includegraphics[scale=0.25]{cic_node_C}}
	\caption{Grade de ocupação do nó C}
	\label{fig:grade_no_C}
\end{figure}
\begin{figure}
	\centering
	\fbox{\includegraphics[scale=0.2]{cic_node_D}}
	\caption{Grade de ocupação do nó D}
	\label{fig:grade_no_D}
\end{figure}
\begin{figure}
	\centering
	\fbox{\includegraphics[scale=0.2]{cic_node_E}}
	\caption{Grade de ocupação do nó E}
	\label{fig:grade_no_E}
\end{figure}
\begin{figure}
	\centering
	\fbox{\includegraphics[scale=0.25]{cic_node_F}}
	\caption{Grade de ocupação do nó F}
	\label{fig:grade_no_F}
\end{figure}
\begin{figure}
	\centering
	\fbox{\includegraphics[angle=90,scale=0.25]{cic_node_G}}
	\caption{Grade de ocupação do nó G}
	\label{fig:grade_no_G}
\end{figure}
\begin{figure}
	\centering
	\fbox{\includegraphics[scale=0.25]{cic_node_H}}
	\caption{Grade de ocupação do nó H}
	\label{fig:grade_no_H}
\end{figure}
\begin{figure}
	\centering
	\fbox{\includegraphics[scale=0.25]{cic_node_I}}
	\caption{Grade de ocupação do nó I}
	\label{fig:grade_no_I}
\end{figure}
\begin{figure}
	\centering
	\fbox{\includegraphics[scale=0.25]{cic_node_J}}
	\caption{Grade de ocupação do nó J}
	\label{fig:grade_no_J}
\end{figure}
\begin{figure}
	\centering
	\fbox{\includegraphics[scale=0.25]{cic_node_K}}
	\caption{Grade de ocupação do nó K}
	\label{fig:grade_no_K}
\end{figure}
\begin{figure}
	\centering
	\fbox{\includegraphics[angle=90,scale=0.25]{cic_node_L}}
	\caption{Grade de ocupação do nó L}
	\label{fig:grade_no_L}
\end{figure}
\begin{figure}
	\centering
	\fbox{\includegraphics[scale=0.25]{cic_node_M}}
	\caption{Grade de ocupação do nó M}
	\label{fig:grade_no_M}
\end{figure}
\begin{figure}
	\centering
	\fbox{\includegraphics[scale=0.25]{cic_node_N}}
	\caption{Grade de ocupação do nó N}
	\label{fig:grade_no_N}
\end{figure}
\begin{figure}
	\centering
	\fbox{\includegraphics[scale=0.25]{cic_node_O}}
	\caption{Grade de ocupação do nó O}
	\label{fig:grade_no_O}
\end{figure}
\begin{figure}
	\centering
	\fbox{\includegraphics[scale=0.25]{cic_node_P}}
	\caption{Grade de ocupação do nó P}
	\label{fig:grade_no_P}
\end{figure}
\begin{figure}
	\centering
	\fbox{\includegraphics[angle=90,scale=0.25]{cic_node_Q}}
	\caption{Grade de ocupação do nó Q}
	\label{fig:grade_no_Q}
\end{figure}
\begin{figure}
	\centering
	\fbox{\includegraphics[scale=0.25]{cic_node_R}}
	\caption{Grade de ocupação do nó R}
	\label{fig:grade_no_R}
\end{figure}

\pagebreak
\section{Controle de movimento} \label{sec:movement}
O controle de movimento utiliza três dados para determinar as velocidade linear e angular do Pioneer, esses dados são as leituras de distâncias realizados pelo sensor laser, a posição absoluta determinada pelo odômetro e uma lista com as posições absolutas dos próximos objetivos, que é obtida tanto pela entrada direta do usuário como o planejamento de trajetória do mapa discutido na seção \ref{subsec:path}.

O controle de movimento possui dois modos de operação distintos, explicados a seguir.

\subsection{Sem obstáculo no caminho} \label{subscs:no_object}
Quando não há obstáculo no caminho o controle de movimento funciona de maneira bem simples, ajustando as velocidades linear e angular de forma que o Pioneer se movimente em direção do próximo objetivo.

\subsection{obstáculo no caminho} \label{subsec:object}
Quando um obstáculo é identificado no caminho entre a posição atual e o próximo objetivo, o controle de movimento entra em uma modo de funcionamento diferente que evita o obstáculo que continua tentando fazer o Pioneer se aproximar do objetivo mas sem colidir com o obstáculo.

O comportamento do Pioneer nesse modo é semelhante ao algoritmo Bug-0 descrito na referência \cite{Bug}. E pode ser descrito de forma simplificada pelo seguinte pseudocódigo.

\pagebreak
\begin{algorithmic}
\While{\textbf{NOT} Chegou no objetivo}
	\If{Sem obstáculo}
		\State \Call{volta\_para\_modo\_normal}{ }
	\ElsIf{Distância crítica}
		\State velocidade\_linear = 0
		\State \Call{rotaciona}{ }
	\ElsIf{Direita livre}
		\State \Call{desvia\_pela\_direita}{ }
	\ElsIf{Esquerda livre}
		\State \Call{desvia\_pela\_esquerda}{ }
	\Else
		\State \Call{encontra\_menor\_angulo\_de\_escape}{ }
		\State \Call{rotaciona\_para\_angulo\_de\_escape}{ }
	\EndIf
\EndWhile
\end{algorithmic}


\section{Mapa topológico} \label{sec:graph}
\subsection{Implementação}
O mapa topológico foi implementado representando regiões como nós de um grafo e os possíveis caminhos entre regiões são representados pelas arestas do grafo, seguindo o modelo relacional descrito nas referências \cite{AI} e \cite{slides}.

\subsection{Definição do mapa topológico}
O grafo que representando o mapa topológico pode ser facilmente alterado pois ele é definido em um arquivo de texto comum separado da implementação, esse arquivo possui três tipos de dados sobre o grafo, informações sobre as arestas e um caminho fechado que para percorrer todas as regiões do grafo, esse caminho é utilizado na construção da grade de ocupação.

A definição do mapa topológico do segundo andar do prédio do CIC encontra-se no arquivo \textit{CIC\_graph.txt} e nas tabelas \ref{node-table} e \ref{edge-table}.

\begin{table}[]
\centering
\caption{Definição dos nós do mapa topológico do CIC}
\label{node-table}
\begin{tabular}{|c|c|c|c|c|}
\hline
ID & Ponto central X & Ponto central Y & Tolerância X & Tolerância Y \\ \hline
A & -27.5 & 18 & 2.5 & 2 \\ \hline
B & -27.5 & 9 & 2.5 & 7 \\ \hline
C & -27.5 & 0 & 2.5 & 2 \\ \hline
D & -14 & 18 & 11 & 2 \\ \hline
E & -14 & 0 & 11 & 2 \\ \hline
F & -1 & 18 & 2 & 2 \\ \hline
G & -1 & 9 & 2 & 7 \\ \hline
H & -1 & 0 & 2 & 2 \\ \hline
I & 8 & 18 & 7 & 2 \\ \hline
J & 8 & 0 & 7 & 2 \\ \hline
K & 19 & 18 & 4 & 2 \\ \hline
L & 19 & 9 & 4 & 7 \\ \hline
M & 19 & 0 & 4 & 2 \\ \hline
N & 30 & 18 & 7 & 2 \\ \hline
O & 30 & 0 & 7 & 2 \\ \hline
P & 38.5 & 18 & 1.5 & 2 \\ \hline
Q & 38.5 & 9 & 1.5 & 7 \\ \hline
R & 38.5 & 0 & 1.5 & 2 \\ \hline
\end{tabular}
\end{table}

\begin{table}[]
\centering
\caption{Definição das arestas do mapa topológico do CIC}
\label{edge-table}
\begin{tabular}{|c|c|c|}
\hline
Nó ID & Nó ID & Custo entre os nós \\ \hline
A & B & 18 \\ \hline
A & D & 26 \\ \hline
D & F & 29 \\ \hline
F & G & 19 \\ \hline
F & I & 20 \\ \hline
I & K & 21 \\ \hline
K & L & 18 \\ \hline
K & N & 24 \\ \hline
N & P & 18 \\ \hline
P & Q & 18 \\ \hline
Q & R & 18 \\ \hline
R & O & 18 \\ \hline
O & M & 24 \\ \hline
M & L & 18 \\ \hline
M & J & 23 \\ \hline
J & H & 20 \\ \hline
H & G & 19 \\ \hline
H & E & 28 \\ \hline
E & C & 27 \\ \hline
C & B & 19 \\ \hline
\end{tabular}
\end{table}


\subsection{Planejamento de trajetoria} \label{subsec:path}
O planejamento de trajetórias no mapa topológico é feito utilizando o algoritmo de menor caminho de Dijkstra, como descrito no pseudocódigo a seguir.
\includegraphics[scale=0.7]{Dijkstra}

A função encontra a sequência de nós entre a posição atual e final com o menor custo e adiciona essa sequência na lista de próximos objetivos do Pioneer.




\section{Grade de ocupação} \label{sec:grid}
A construção da grade de ocupação é feita percorrendo todos os nós ou regiões do mapa topológico realizando constantemente leituras do odômetro e sensor de distância.
	
Com a informação dos sensores é possível determinar se as células da grade de ocupação dentro do alcance do sensor laser estão livre ou ocupadas, as células que não foi possível obter alguma informação são marcadas como indefinidas e com probabilidade de 50\% de estarem ocupadas ou livres.

Cada nó ou região do mapa topológico possui sua grade de ocupação, o resultado da grade é mostrado em tempo de simulação pelo RViz como mostra a figura \ref{fig:rviz} e após todas as grades estarem completas a informação de cada grade é salva em um arquivo como explicado na seção \ref{grid_file}





\begin{thebibliography}{9}

\bibitem{Bug}
	Howie Choset with slides from G.D. Hager and Z. Dodds,
	Robotic Motion Planning: Bug Algorithms
	16-735

\bibitem{AI}
	Robin R. Murphy. 2000,
	Introduction to AI Robotics (1st ed.),
	MIT Press, Cambridge, MA, USA. 
	
\bibitem{slides}
	Carla Koike,
	Slides da disciplina Fundamentos Computacionais de Robótica,
	Departamento de Ciência da Computação, UnB.
	
\bibitem{primer}
	Maja J. Matarić,
	The Robotics Primer,
	MIT Press.

\end{thebibliography}

\end{document}
